{% extends "base.html" %}

{% block content %}
<div class="row">
    <!-- Sidebar -->
    <div class="col-md-3">
        <div class="sidebar">
            <h4 class="mb-3">üìÇ Data Management</h4>
            
            <!-- File Upload -->
            <form action="{{ url_for('process_files_route') }}" method="post" enctype="multipart/form-data" class="mb-3">
                <div class="mb-3">
                    <label for="uploadFiles" class="form-label">Upload files</label>
                    <input class="form-control form-control-sm" type="file" id="uploadFiles" name="files[]" multiple>
                    <small class="text-muted">Supported: PDF, PPTX, DOCX, PNG, JPG</small>
                </div>
                <button type="submit" class="btn btn-primary btn-sm">Process Files</button>
            </form>
            
            <!-- Website Scraper -->
            <form action="{{ url_for('scrape_site_route') }}" method="post" class="mb-3" autocomplete="off">
                <div class="mb-3">
                    <label for="websiteUrl" class="form-label">Or enter website URL</label>
                    <input type="url" class="form-control form-control-sm" id="websiteUrl" name="url">
                </div>
                <button type="submit" class="btn btn-primary btn-sm">Scrape Site</button>
            </form>
            
            <!-- Clear Data Button -->
            <form action="{{ url_for('clear_data_route') }}" method="post" class="mb-4">
                <button type="submit" class="btn btn-outline-danger btn-sm">
                    <i class="fas fa-broom"></i> Clear All Data
                </button>
            </form>
            
            <hr>
            
            <!-- Chat Export Options -->
            <h4 class="mb-3">Chat Export</h4>
            <form action="{{ url_for('export_chat') }}" method="post">
                <div class="mb-3">
                    <label class="form-label">Format</label>
                    <div class="d-flex">
                        <div class="form-check me-3">
                            <input class="form-check-input" type="radio" name="export_format" id="formatJson" value="json" checked>
                            <label class="form-check-label" for="formatJson">JSON</label>
                        </div>
                        <div class="form-check me-3">
                            <input class="form-check-input" type="radio" name="export_format" id="formatTxt" value="txt">
                            <label class="form-check-label" for="formatTxt">TXT</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="export_format" id="formatPdf" value="pdf">
                            <label class="form-check-label" for="formatPdf">PDF</label>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-outline-secondary btn-sm">Export Chat History</button>
            </form>
        </div>
    </div>
    
    <!-- Main Chat Area -->
    <div class="col-md-9">
        <h1 class="mb-2">ü§ñ Advanced Gemini RAG System</h1>
        <p class="text-muted">Now with RAG-Fusion, Multi-Query, Decomposition + Notes</p>
        
        <!-- Web Search Toggle -->
        <div class="mb-3">
            <h5>üåê Web Search Fallback</h5>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="useWebSearch" {% if not GOOGLE_API_KEY or not GOOGLE_CSE_ID or GOOGLE_API_KEY == "" or GOOGLE_CSE_ID == "" %}disabled{% endif %}>
                <label class="form-check-label" for="useWebSearch">Search from web if no document matches</label>
            </div>
            {% if not GOOGLE_API_KEY or not GOOGLE_CSE_ID or GOOGLE_API_KEY == "" or GOOGLE_CSE_ID == "" %}
            <div class="alert alert-warning mt-2">
                <small>Please set GOOGLE_API_KEY and GOOGLE_CSE_ID in .env to enable web search</small>
            </div>
            {% endif %}
        </div>
        
        <hr>
        
        <!-- Chat Container -->
        <div class="chat-container" id="chatMessages">
            <!-- Messages will be dynamically inserted here -->
        </div>
        
        <!-- Chat Input -->
        <form id="chatForm" class="mb-4" autocomplete="off">
            <div class="input-group">
                <input type="text" id="promptInput" class="form-control" placeholder="Ask about your documents..." required autocomplete="off">
                <button class="btn btn-primary" type="submit">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
            </div>
        </form>
        
        <!-- Notes Button -->
        <button id="toggleNotesBtn" class="float-notes-btn">
            Notes <i class="fas fa-plus"></i>
        </button>
        
        <form id="anchorForm" class="anchor-form">
  <input type="text" id="conceptInput" class="anchor-input" placeholder="Enter a concept..." />
  <button type="submit" class="anchor-button">Generate Anchor</button>
</form>
<div class="anchor-glow-wrapper">
  <div id="anchorResult" class="anchor-result hidden">
    <h3 id="anchorTerm" class="anchor-term"></h3>
    <p><strong>Summary:</strong> <span id="anchorSummary"></span></p>
    <p><strong>Mnemonic:</strong> <span id="anchorMnemonic"></span></p>
    <p><strong>Example:</strong> <span id="anchorExample"></span></p>
  </div>
</div>

        <!-- Notes Container (Hidden by default) -->
        <div id="notesContainer" class="notes-container" style="display: none;">
            <h4 class="mb-3">üìù Notes Editor</h4>
            <div id="quillEditor"></div>
            <div class="mt-3 d-flex justify-content-between">
                <button id="saveNotesBtn" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Notes
                </button>
                <form action="{{ url_for('export_notes_pdf') }}" method="post">
                    <button type="submit" class="btn btn-outline-secondary">
                        <i class="fas fa-download"></i> Download Notes as PDF
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize Quill editor
    const quill = new Quill('#quillEditor', {
        theme: 'snow',
        placeholder: 'Write your notes here...',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['link', 'blockquote', 'code-block'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'align': [] }]
            ]
        }
    });
    
    // Toggle notes panel
    $('#toggleNotesBtn').click(function() {
        $.post('/toggle-notes', function(data) {
            if (data.show_notes) {
                $('#notesContainer').slideDown();
                $('#toggleNotesBtn').html('Notes <i class="fas fa-minus"></i>');
            } else {
                $('#notesContainer').slideUp();
                $('#toggleNotesBtn').html('Notes <i class="fas fa-plus"></i>');
            }
        });
    });
    
    // Save notes
    $('#saveNotesBtn').click(function() {
        const notesContent = quill.root.innerHTML;
        $.post('/save-notes', { notes_content: notesContent }, function(data) {
            if (data.success) {
                const alert = $('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                    'Notes saved successfully!' +
                    '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                    '</div>');
                $('.flash-messages').append(alert);
                setTimeout(function() { alert.alert('close'); }, 3000);
            }
        });
    });
    
    // Handle chat form submission
    $('#chatForm').submit(function(event) {
        event.preventDefault();
        const prompt = $('#promptInput').val();
        const useWebSearch = $('#useWebSearch').is(':checked');
        
        if (!prompt) return;
        
        // Add user message to chat
        addMessage('user', prompt);
        
        // Clear input
        $('#promptInput').val('');
        
        // Show loading indicator
        const loadingMessage = $('<div class="assistant-message loading">Thinking...</div>');
        $('#chatMessages').append(loadingMessage);
        scrollToBottom();
        
        // Send request to server
        $.post('/chat', { 
            prompt: prompt,
            use_web_search: useWebSearch ? 'on' : 'off'
        }, function(data) {
            // Remove loading indicator
            $('.loading').remove();
            
            // Add assistant message
            addMessage('assistant', data.response);
        }).fail(function(error) {
            $('.loading').remove();
            const errorMessage = error.responseJSON?.error || 'An error occurred while processing your request.';
            addMessage('assistant', '‚ö†Ô∏è ' + errorMessage);
        });
    });
    
    // Function to add a message to the chat
    function addMessage(role, content) {
        const messageClass = role === 'user' ? 'user-message' : 'assistant-message';
        const messageElement = $('<div class="' + messageClass + '"></div>');
        
        // For assistant messages, render markdown
        if (role === 'assistant') {
            messageElement.html(renderMarkdown(content));
        } else {
            messageElement.text(content);
        }
        
        $('#chatMessages').append(messageElement);
        scrollToBottom();
    }
    
    // Function to scroll chat to bottom
    function scrollToBottom() {
        const chatContainer = document.getElementById('chatMessages');
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // Load existing messages on page load
    function loadMessages() {
        fetch('/messages')
            .then(response => response.json())
            .then(data => {
                if (data.messages && data.messages.length) {
                    data.messages.forEach(msg => {
                        addMessage(msg.role, msg.content);
                    });
                }
            })
            .catch(error => console.error('Error loading messages:', error));
    }
    
    // Load notes on page load
    function loadNotes() {
        fetch('/notes')
            .then(response => response.json())
            .then(data => {
                if (data.notes) {
                    quill.root.innerHTML = data.notes;
                }
                if (data.show_notes) {
                    $('#notesContainer').show();
                    $('#toggleNotesBtn').html('Notes <i class="fas fa-minus"></i>');
                }
            })
            .catch(error => console.error('Error loading notes:', error));
    }
    
document.getElementById("anchorForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  const context = document.getElementById("conceptInput").value;
  const button = document.querySelector(".anchor-button");
  const result = document.getElementById("anchorResult");

  button.disabled = true;
  button.innerText = "Generating...";

  const res = await fetch("http://127.0.0.1:5000/generate-anchor", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ context }),
  });

  const data = await res.json();
  button.disabled = false;
  button.innerText = "Generate Anchor";

 if (data.status === "success") {
  document.getElementById("anchorTerm").innerText = data.anchor.term;
  document.getElementById("anchorSummary").innerText = data.anchor.summary;
  document.getElementById("anchorMnemonic").innerText = data.anchor.mnemonic;
  document.getElementById("anchorExample").innerText = data.anchor.example;

  result.classList.remove("hidden");
  result.classList.add("visible");
  result.style.display = "block"; // ensure it becomes visible
  result.scrollIntoView({ behavior: "smooth" });
} else {
  alert("Error: " + data.message);
}
});
    // Initialize on page load
    $(document).ready(function() {
        loadMessages();
        loadNotes();
    });
</script>
{% endblock %} 