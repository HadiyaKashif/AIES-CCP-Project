{% extends "base.html" %}

{% block content %}
<div class="row">
    <!-- Sidebar -->
    <div class="col-md-3">
        <div class="sidebar">
            <h4 class="mb-3">Data Management</h4>
            
            <!-- File Upload -->
            <form action="{{ url_for('process_files_route') }}" method="post" enctype="multipart/form-data" class="mb-4">
                <div class="mb-3">
                    <label for="uploadFiles" class="form-label">Upload files</label>
                    <input class="form-control" type="file" id="uploadFiles" name="files[]" multiple>
                    <small class="text-muted">Supported: PDF, PPTX, DOCX, PNG, JPG</small>
                </div>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-upload me-2"></i>Process Files
                </button>
            </form>
            
            <!-- Website Scraper -->
            <form action="{{ url_for('scrape_site_route') }}" method="post" class="mb-4">
                <div class="mb-3">
                    <label for="websiteUrl" class="form-label">Or enter website URL</label>
                    <input type="url" class="form-control" id="websiteUrl" name="url" placeholder="https://...">
                </div>
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-globe me-2"></i>Scrape Site
                </button>
            </form>
            
            <!-- Clear Data Button -->
            <form action="{{ url_for('clear_data_route') }}" method="post" class="mb-4">
                <button type="submit" class="btn btn-outline-danger w-100">
                    <i class="fas fa-broom me-2"></i>Clear All Data
                </button>
            </form>
            
            <hr>
            
            <!-- Chat Export Options -->
            <h4 class="mb-3">Export Options</h4>
            <form action="{{ url_for('export_chat') }}" method="post">
                <div class="mb-3">
                    <label class="form-label">Export Format</label>
                    <div class="d-flex gap-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="export_format" id="formatJson" value="json" checked>
                            <label class="form-check-label" for="formatJson">JSON</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="export_format" id="formatTxt" value="txt">
                            <label class="form-check-label" for="formatTxt">TXT</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="export_format" id="formatPdf" value="pdf">
                            <label class="form-check-label" for="formatPdf">PDF</label>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-outline-primary w-100">
                    <i class="fas fa-download me-2"></i>Export Chat History
                </button>
            </form>
        </div>
    </div>
    
    <!-- Main Chat Area -->
    <div class="col-md-9">
        <h1 class="mb-2">Advanced Gemini RAG System</h1>
        <p class="text-muted">RAG-Fusion, Multi-Query, Decomposition with Notes</p>
        
        <!-- Web Search Toggle -->
        <div class="mb-4">
            <h5>Web Search Fallback</h5>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="useWebSearch" {% if not GOOGLE_API_KEY or not GOOGLE_CSE_ID or GOOGLE_API_KEY == "" or GOOGLE_CSE_ID == "" %}disabled{% endif %}>
                <label class="form-check-label" for="useWebSearch">Search from web if no document matches</label>
            </div>
            {% if not GOOGLE_API_KEY or not GOOGLE_CSE_ID or GOOGLE_API_KEY == "" or GOOGLE_CSE_ID == "" %}
            <div class="alert alert-warning mt-2">
                <small>Please set GOOGLE_API_KEY and GOOGLE_CSE_ID in .env to enable web search</small>
            </div>
            {% endif %}
        </div>
        
        <hr>
        
        <!-- Chat Container -->
        <div class="chat-container" id="chatMessages">
            <!-- Messages will be dynamically inserted here -->
        </div>
        
        <!-- Chat Input -->
        <form id="chatForm" class="mb-4">
            <div class="input-group">
                <input type="text" id="promptInput" class="form-control" placeholder="Ask about your documents..." required>
                <button class="btn btn-primary" type="submit">
                    <i class="fas fa-paper-plane me-2"></i>Send
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Notes Toggle Button -->
<button id="toggleNotesBtn" class="notes-toggle-btn">
    <i class="fas fa-note-sticky"></i>
</button>

<!-- Notes Drawer -->
<div id="notesDrawer" class="notes-drawer">
    <h4 class="mb-3">Notes</h4>
    <div id="quillEditor"></div>
    <div class="mt-3 d-flex gap-2">
        <button id="saveNotesBtn" class="btn btn-primary flex-grow-1">
            <i class="fas fa-save me-2"></i>Save Notes
        </button>
        <form action="{{ url_for('export_notes_pdf') }}" method="post" class="flex-grow-1">
            <button type="submit" class="btn btn-outline-primary w-100">
                <i class="fas fa-file-pdf me-2"></i>Export PDF
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize Quill editor
    const quill = new Quill('#quillEditor', {
        theme: 'snow',
        placeholder: 'Write your notes here...',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['link', 'blockquote', 'code-block'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'align': [] }]
            ]
        }
    });
    
    // Toggle notes drawer
    $('#toggleNotesBtn').click(function() {
        const drawer = $('#notesDrawer');
        const button = $(this);
        
        if (drawer.hasClass('open')) {
            drawer.removeClass('open');
            button.removeClass('open');
        } else {
            drawer.addClass('open');
            button.addClass('open');
        }
        
        $.post('/toggle-notes');
    });
    
    // Save notes
    $('#saveNotesBtn').click(function() {
        const notesContent = quill.root.innerHTML;
        $.post('/save-notes', { notes_content: notesContent }, function(data) {
            if (data.success) {
                const alert = $('<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                    'Notes saved successfully!' +
                    '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                    '</div>');
                $('.flash-messages').append(alert);
                setTimeout(function() { alert.alert('close'); }, 3000);
            }
        });
    });
    
    // Handle chat form submission
    $('#chatForm').submit(function(event) {
        event.preventDefault();
        const prompt = $('#promptInput').val();
        const useWebSearch = $('#useWebSearch').is(':checked');
        
        if (!prompt) return;
        
        // Add user message to chat
        addMessage('user', prompt);
        
        // Clear input
        $('#promptInput').val('');
        
        // Show loading indicator
        const loadingMessage = $('<div class="assistant-message loading">Thinking...</div>');
        $('#chatMessages').append(loadingMessage);
        scrollToBottom();
        
        // Send request to server
        $.post('/chat', { 
            prompt: prompt,
            use_web_search: useWebSearch ? 'on' : 'off'
        }, function(data) {
            // Remove loading indicator
            $('.loading').remove();
            
            // Add assistant message
            addMessage('assistant', data.response);
        }).fail(function(error) {
            $('.loading').remove();
            const errorMessage = error.responseJSON?.error || 'An error occurred while processing your request.';
            addMessage('assistant', 'Error: ' + errorMessage);
        });
    });
    
    // Function to add a message to the chat
    function addMessage(role, content) {
        const messageClass = role === 'user' ? 'user-message' : 'assistant-message';
        const messageElement = $('<div class="' + messageClass + '"></div>');
        
        // For assistant messages, render markdown
        if (role === 'assistant') {
            messageElement.html(renderMarkdown(content));
        } else {
            messageElement.text(content);
        }
        
        $('#chatMessages').append(messageElement);
        scrollToBottom();
    }
    
    // Function to scroll chat to bottom
    function scrollToBottom() {
        const chatContainer = document.getElementById('chatMessages');
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // Load existing messages on page load
    function loadMessages() {
        fetch('/messages')
            .then(response => response.json())
            .then(data => {
                if (data.messages && data.messages.length) {
                    data.messages.forEach(msg => {
                        addMessage(msg.role, msg.content);
                    });
                }
            })
            .catch(error => console.error('Error loading messages:', error));
    }
    
    // Load notes on page load
    function loadNotes() {
        fetch('/notes')
            .then(response => response.json())
            .then(data => {
                if (data.notes) {
                    quill.root.innerHTML = data.notes;
                }
                if (data.show_notes) {
                    $('#notesDrawer').addClass('open');
                    $('#toggleNotesBtn').addClass('open');
                }
            })
            .catch(error => console.error('Error loading notes:', error));
    }
    
    // Initialize
    loadMessages();
    loadNotes();
</script>
{% endblock %} 